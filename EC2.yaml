AWSTemplateFormatVersion: "2010-09-09"
Description: "Template CloudFormation para criar uma inst√¢ncia EC2 para o e-commerce"

Parameters:
  KeyName:
    Description: Nome do par de chaves SSH para acessar a inst√¢ncia
    Type: AWS::EC2::KeyPair::KeyName

  InstanceType:
    Description: Tipo da inst√¢ncia EC2
    Type: String
    Default: t3.micro
    AllowedValues:
      - t2.micro
      - t3.micro
      - t3.small
      - t3.medium
    ConstraintDescription: deve ser um tipo de inst√¢ncia EC2 v√°lido.

  VpcId:
    Description: VPC onde a inst√¢ncia ser√° criada
    Type: AWS::EC2::VPC::Id

  SubnetId:
    Description: Sub-rede dentro da VPC
    Type: AWS::EC2::Subnet::Id

Resources:
  # Security Group permitindo HTTP e SSH
  EcommerceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Permitir HTTP e SSH para inst√¢ncia do e-commerce
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0   # Aten√ß√£o: aberto para todos, ideal restringir ao seu IP
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0

  # Inst√¢ncia EC2
  EcommerceEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyName
      ImageId: ami-08c40ec9ead489470 # Amazon Linux 2 AMI (us-east-1) ‚Üí altere se usar outra regi√£o
      SubnetId: !Ref SubnetId
      SecurityGroupIds:
        - !Ref EcommerceSecurityGroup
      Tags:
        - Key: Name
          Value: Ecommerce-EC2
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y httpd
          systemctl start httpd
          systemctl enable httpd
          echo "<h1>Servidor do E-commerce rodando na EC2 üöÄ</h1>" > /var/www/html/index.html

Outputs:
  InstanceId:
    Description: ID da inst√¢ncia EC2
    Value: !Ref EcommerceEC2Instance

  PublicIP:
    Description: IP p√∫blico da inst√¢ncia
    Value: !GetAtt EcommerceEC2Instance.PublicIp

  WebURL:
    Description: URL HTTP para acessar a aplica√ß√£o
    Value: !Sub "http://${EcommerceEC2Instance.PublicDnsName}"
